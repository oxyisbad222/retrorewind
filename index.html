<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Rewind</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #1a1a1a;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        /* Main container for the top section (TV and Console) */
        .game-station {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2rem;
            width: 100%;
        }
        @media (min-width: 1024px) { /* lg breakpoint */
            .game-station {
                flex-direction: row;
                align-items: flex-end;
                justify-content: center;
            }
        }

        .tv-wrapper {
            background-image: url('https://raw.githubusercontent.com/oxyisbad222/retrorewind/main/assets/TV/Frame.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: relative;
            width: 90vw;
            max-width: 800px;
            aspect-ratio: 512 / 448; 
            flex-shrink: 0;
        }
        .screen-container {
            position: absolute;
            background: #000;
            overflow: hidden;
            top: 9.5%;
            left: 12.5%;
            width: 75%;
            height: 65%;
        }
        #nes-screen {
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        #screen-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }
        .tv-reflection {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 15%);
            pointer-events: none;
        }
        .power-light {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #660000;
            border: 2px solid #ff0000;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
            transition: all 0.3s;
        }
        .power-light.on {
            background-color: #ff0000;
            box-shadow: 0 0 10px #ff0000, 0 0 20px #ff0000;
        }
        .cartridge-wrapper {
            transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out;
            cursor: pointer;
        }
        .cartridge-wrapper:hover {
            transform: translateY(-5px) scale(1.05);
            filter: drop-shadow(0 0 15px #facc15);
        }
        .game-cover {
            /* Positioning for vertical cover art on the cartridge */
            position: absolute;
            width: 78%;
            height: 55%;
            top: 10%;
            left: 11%;
            object-fit: contain;
            pointer-events: none;
            image-rendering: pixelated;
        }
    </style>
</head>
<body class="bg-gray-900 flex flex-col items-center min-h-screen p-4">

    <header class="text-center mb-6">
        <h1 class="text-4xl md:text-5xl font-bold text-yellow-400 tracking-wider">Retro Rewind</h1>
        <p class="text-gray-400 mt-2">Click a cartridge to power up the system!</p>
    </header>

    <main class="w-full max-w-7xl mx-auto">
        <div class="game-station">
            <!-- TV and Emulator -->
            <div class="tv-wrapper">
                <div class="screen-container">
                    <canvas id="nes-screen" width="256" height="240"></canvas>
                    <div id="screen-overlay"></div>
                    <div class="tv-reflection"></div>
                </div>
            </div>

            <!-- NES Console -->
            <div id="console-area" class="w-full max-w-xs md:max-w-sm lg:max-w-xs flex-shrink-0">
                <img src="https://raw.githubusercontent.com/oxyisbad222/retrorewind/main/assets/Console/NES.png" alt="NES Console" class="w-full h-auto">
                <div class="flex items-center gap-4 p-4 justify-center mt-[-10px]">
                    <div class="power-light" id="power-light"></div>
                    <div class="text-gray-400 font-sans text-sm">POWER</div>
                </div>
            </div>
        </div>

        <!-- Game Cartridge Selection -->
        <section id="game-selection" class="w-full mt-12 p-4">
            <h2 class="text-2xl text-center mb-6 border-b-2 border-gray-700 pb-2">Game Library</h2>
            <div id="cartridge-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6 md:gap-8">
                <!-- Cartridges will be injected here by JavaScript -->
            </div>
        </section>

        <!-- Controls Info -->
        <section id="controls-info" class="text-center mt-12 p-4 bg-gray-800/50 rounded-lg border border-gray-700 w-full">
            <h3 class="text-xl mb-4">Controls</h3>
            <img src="https://raw.githubusercontent.com/oxyisbad222/retrorewind/main/assets/ControllerDiagrams/Color/DiagramText.png" alt="Controller Diagram" class="mx-auto mb-4 max-w-full h-auto px-4" style="max-width: 400px;">
            <p class="mt-4 text-xs text-gray-400">Keyboard: Arrows, X (A), Z (B), Enter (Start), Shift (Select). Gamepad also supported.</p>
        </section>
    </main>
    
    <footer class="text-center text-gray-500 text-sm mt-8 pb-4">
        <p>SkyeDev &lt;3</p>
    </footer>

    <!-- Error Modal -->
    <div id="error-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg text-center max-w-sm mx-4 border border-red-500">
            <h3 class="text-xl text-red-500 mb-4">Loading Error</h3>
            <p id="error-message" class="text-gray-300 mb-6"></p>
            <button id="close-modal-btn" class="bg-yellow-500 text-gray-900 px-6 py-2 rounded font-bold hover:bg-yellow-400 transition-colors">OK</button>
        </div>
    </div>

    <!-- JSNES Library -->
    <script src="https://unpkg.com/jsnes/dist/jsnes.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const GITHUB_BASE_URL = 'https://raw.githubusercontent.com/oxyisbad222/retrorewind/main/';
            const ASSET_FOLDER = GITHUB_BASE_URL + 'assets/';
            const ROM_FOLDER = ASSET_FOLDER + 'games/';
            const COVER_FOLDER = ASSET_FOLDER + 'covers/';

            const games = [
                { id: 'super_mario_bros', name: 'Super Mario Bros.', rom: 'smb.nes' },
                { id: 'mega_man_2', name: 'Mega Man 2', rom: 'megaman2.nes' },
                { id: 'pac_man', name: 'Pac-Man', rom: 'pacman.nes' },
                { id: 'punch_out', name: 'Mike Tyson\'s Punch-Out!!', rom: 'punchout.nes' },
                { id: 'contra', name: 'Contra', rom: 'contra.nes' }
            ];

            // --- DOM ELEMENTS ---
            const cartridgeContainer = document.getElementById('cartridge-container');
            const canvas = document.getElementById('nes-screen');
            const screenOverlay = document.getElementById('screen-overlay');
            const powerLight = document.getElementById('power-light');
            const errorModal = document.getElementById('error-modal');
            const errorMessage = document.getElementById('error-message');
            const closeModalBtn = document.getElementById('close-modal-btn');

            let nes;
            let frameTimer;

            // --- INITIALIZATION ---
            function initialize() {
                populateCartridges();
                setScreenOverlay(ASSET_FOLDER + 'Splash/NES.png');
                closeModalBtn.addEventListener('click', () => errorModal.classList.add('hidden'));
            }

            // --- UI FUNCTIONS ---
            function populateCartridges() {
                games.forEach(game => {
                    const coverUrl = `${COVER_FOLDER}${game.id}.jpg`;
                    const placeholderUrl = `https://placehold.co/112x154/222222/FFFFFF?text=${encodeURIComponent(game.name)}`;
                    const cartFrontUrl = ASSET_FOLDER + 'Cartridge/Front.png';
                    
                    const cartElement = document.createElement('div');
                    cartElement.className = 'cartridge-wrapper relative';
                    cartElement.innerHTML = `
                        <img src="${cartFrontUrl}" alt="NES Cartridge" class="w-full h-auto block drop-shadow-lg">
                        <img src="${coverUrl}" 
                             alt="${game.name}" 
                             class="game-cover"
                             onerror="this.onerror=null;this.src='${placeholderUrl}';">
                        <div class="absolute bottom-0 w-full p-2 bg-black/60 pointer-events-none">
                            <p class="text-center text-xs truncate">${game.name}</p>
                        </div>
                    `;
                    cartElement.addEventListener('click', () => loadGame(game));
                    cartridgeContainer.appendChild(cartElement);
                });
            }

            function setScreenOverlay(imageUrl) {
                if (imageUrl) {
                    screenOverlay.style.backgroundImage = `url('${imageUrl}')`;
                    screenOverlay.style.display = 'block';
                    powerLight.classList.remove('on');
                } else {
                    screenOverlay.style.display = 'none';
                    powerLight.classList.add('on');
                }
            }
            
            function showError(message) {
                errorMessage.textContent = message;
                errorModal.classList.remove('hidden');
            }

            // --- EMULATOR LOGIC ---
            function loadGame(game) {
                const romUrl = ROM_FOLDER + game.rom;
                console.log(`Loading game: ${game.name} from ${romUrl}`);
                setScreenOverlay(ASSET_FOLDER + 'Splash/Nintendo.png'); // Show splash while loading
                
                // Stop any existing emulation
                if (frameTimer) {
                    clearInterval(frameTimer);
                }
                if (nes) {
                    nes.stop();
                }

                fetch(romUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Network response was not ok: ${response.statusText}. Could not find ROM file. Make sure the GitHub URL and file paths are correct.`);
                        }
                        return response.arrayBuffer();
                    })
                    .then(arrayBuffer => {
                        startGame(new Uint8Array(arrayBuffer));
                    })
                    .catch(error => {
                        console.error('Error loading the ROM:', error);
                        showError(`Failed to load ${game.name}. Please check the console for errors and verify your ROM paths.`);
                        setScreenOverlay(ASSET_FOLDER + 'Splash/NES.png');
                    });
            }

            function startGame(romData) {
                setScreenOverlay(null); // Hide overlay, turn on power light
                
                const context = canvas.getContext('2d');
                const imageData = context.createImageData(256, 240);
                
                // Create a buffer for faster rendering
                const buffer = new ArrayBuffer(imageData.data.length);
                const a32 = new Uint32Array(buffer); // 32-bit view of buffer
                const u8 = new Uint8ClampedArray(buffer); // 8-bit view of buffer

                nes = new jsnes.NES({
                    onFrame: (frameBuffer) => {
                        // This is a much faster way to render the frame than a JS loop
                        for (let i = 0; i < frameBuffer.length; i++) {
                            a32[i] = 0xFF000000 | frameBuffer[i]; // Set alpha to 255 and copy BGR color
                        }
                        imageData.data.set(u8);
                        context.putImageData(imageData, 0, 0);
                    },
                });

                nes.loadROM(romData);
                
                // Start emulation loop
                frameTimer = setInterval(() => {
                    nes.frame();
                }, 1000 / 60);
                
                // Keyboard controls
                const onKey = (isDown, event) => {
                    if (!nes) return;
                    const player = 1;
                    const button = {
                        38: jsnes.Controller.BUTTON_UP,     // Up
                        40: jsnes.Controller.BUTTON_DOWN,   // Down
                        37: jsnes.Controller.BUTTON_LEFT,   // Left
                        39: jsnes.Controller.BUTTON_RIGHT,  // Right
                        88: jsnes.Controller.BUTTON_A,      // 'x' -> A
                        90: jsnes.Controller.BUTTON_B,      // 'z' -> B
                        16: jsnes.Controller.BUTTON_SELECT, // Shift -> Select
                        13: jsnes.Controller.BUTTON_START   // Enter -> Start
                    }[event.keyCode];

                    if (button !== undefined) {
                        if (isDown) nes.buttonDown(player, button);
                        else nes.buttonUp(player, button);
                        event.preventDefault();
                    }
                };

                document.addEventListener('keydown', (event) => onKey(true, event));
                document.addEventListener('keyup', (event) => onKey(false, event));
                
                document.querySelector('.tv-wrapper').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // --- RUN ---
            initialize();
        });
    </script>
</body>
</html>
